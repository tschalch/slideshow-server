version: "3.8"
services:
  init:
    image: alpine:latest
    volumes:
      - ./:/source:ro
      - slides-html:/target
    command: >
      sh -c "
      echo 'Copying website files from Git repo...';
      cp -f /source/*.html /target/ 2>/dev/null || true;
      cp -f /source/*.json /target/ 2>/dev/null || true;
      cp -f /source/*.js /target/ 2>/dev/null || true;
      cp -f /source/*.md /target/ 2>/dev/null || true;
      echo 'Website files copied successfully'
      "
    restart: "no"

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - 8881:80
    volumes:
      - slides-html:/usr/share/nginx/html
    depends_on:
      init:
        condition: service_completed_successfully

  sftp:
    image: atmoz/sftp
    ports:
      - "2222:22"
    volumes:
      - slides-html:/home/slides/upload
    command: slides:Kx12*F%@Ap355Q9q%H2!:82:82
    restart: unless-stopped

  slideshow-generator:
    image: node:20-alpine
    restart: unless-stopped
    working_dir: /app
    volumes:
      - slides-html:/app
    command: node /app/watch-and-generate.js
    environment:
      - NODE_ENV=production
    depends_on:
      init:
        condition: service_completed_successfully

volumes:
  slides-html: {}
